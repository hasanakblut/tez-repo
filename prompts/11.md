# Cursor Master Prompt: Pulse-Level Frequency Agility & Markovian Persistence

**Role:** Senior DSP (Digital Signal Processing) and Reinforcement Learning Engineer.

**Task:** Implement a structured Frequency Generation and Mapping system for a Cognitive Radar Jamming environment based on the provided academic paper.

---

## 1. Frequency Mapping & State Space (The 240-State Lookup Table)

Build a mapping system where each state index $s \in [0, 239]$ corresponds to a specific radar pulse configuration.

- **Hierarchy:** 10 Subbands ($M=10$) and 24 Permutations ($K=4!$) per subband.
- **Mapping Logic:** $\text{Index} = (\text{Subband\_ID} \times 24) + \text{Permutation\_ID}$.

**Frequency Construction:**
- Divide the total bandwidth $B$ into 10 subbands.
- Within each subband, define $K=4$ unique, equidistant carrier frequencies $\{f_1, f_2, f_3, f_4\}$.
- Each Permutation_ID (0–23) must map to a unique sequence of these 4 frequencies.

**Output:** Create an `index_to_freqs` lookup table (shape: 240×4) in RadarEnv.

---

## 2. Markovian Subband Persistence (70/30 Rule)

Implement the FrequencyGenerator using a transition matrix $P$ ($240 \times 240$) that reflects realistic radar "Subband Persistence."

- **Stay Probability (70%):** For any current state $i$ belonging to Subband $S_k$, the sum of probabilities to transition to any state $j$ within the same subband $S_k$ must be **0.70**. This forces the radar to stay in the same frequency band but change its intra-pulse permutation.

- **Jump Probability (30%):** The remaining **0.30** probability must be distributed for transitions to other subbands ($S_{j \neq k}$).

- **Gaussian Weighting:** Distribute the 30% jump probability using a Gaussian curve **centered on the current subband**. Jumps to adjacent subbands ($S_{k \pm 1}$) should be more likely than distant ones.

- **Sparsity:** Within the 70% or 30% allocation, apply a sparsity mask to ensure the radar only visits a subset of permutations, making the pattern learnable for the GRU.

---

## 3. Reward Logic: Intra-Pulse Overlap (Num)

The environment must reward the agent based on the sub-pulse level match count ($Num$).

- **Formula:** $r_t = \text{JSR} \times Num$

- **Calculation:** When the Agent predicts index $A$ and Radar selects index $B$:
  - Retrieve the 4-frequency sequences for both indices from the lookup table.
  - $Num = \sum_{k=1}^4 [f_{\text{agent}, k} = f_{\text{radar}, k}]$

- **Partial Rewards:** This ensures the agent receives feedback even if it only guesses the correct subband but the wrong permutation.

---

## 4. Execution & Seeding

- **Initial State:** The generator must start at a configurable `start_index` (default: 0) to ensure reproducible test runs.
- **Seed Control:** Ensure `env.reset(seed=...)` seeds the FrequencyGenerator's internal RNG.
- **Upcoming Prediction:** The environment must handle the $t+1$ prediction logic, where the agent aims to jam the radar pulse that is just about to be transmitted.
